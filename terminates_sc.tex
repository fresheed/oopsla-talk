\newcommand{\doMath}[1]{\FPeval{\mathResult}{round((#1):0)}\FPprint{\mathResult}}
\newcommand{\evalMRI}[1]{\FPeval{\MRI}{round((#1):0)}} % math result 1
\newcommand{\evalMRII}[1]{\FPeval{\MRII}{round((#1):0)}} % math result 2

\begin{frame}
  \begin{columns}

    \begin{column}{0.4\linewidth}
      
      \only<1-3>{
        \spinlockClientIICS
        % \only<2>{\upd{\showAbstract}{true}}
        % \spinlockClientIIExpandedIter
        
        \begin{tikzpicture}[xscale=1, yscale=1]
          \onslide<2-3>{
            \node (P1) at (0, 0) {\includegraphics[width=0.9\textwidth]{terminated.png}};
            }
          \onslide<3>{
            \node (P2) at (0, 0) {\includegraphics[width=0.7\textwidth]{pending.png}};
            }
        \end{tikzpicture}
      }
    \end{column}

    \begin{column}{0.5\linewidth}
      \only<3>{Existing lock implementations can hang [Oberhauser et al. 2021]}

      % Computed: \doMath{1 + 2}
      % Computed: \fpeval{3 + 4}
    \end{column}

  \end{columns}
  
\end{frame}

% \begin{frame}{Spinlock terminates under sequential consistency \onslide<4->{[Lamport 1979], \ \ \ but now we use other semantics:}}
\begin{frame}{\onslide<2->{Spinlock terminates under interleaving semantics}}
  \setorder{fProg,fScheme,fTimeline,
    fRepI,fCASI,
    fRepII,fCASII,fRepIIs,fCASIIs,
    fWI,fRepIIt,fCASIIt,fWII}
  
  \unselect
  \newcommand{\animBase}{4}
  % doing math inline seems to be impossibe, should precompute it
  % \only<{\doMath{\animBase + 0}}->{\selectI \upd{\progPosI}{I}}
  % \only<{\makeatother\doMath{\animBase}\makeatletter}->{\selectI \upd{\progPosI}{I}}
  % \FPeval{\mathResult}{round((4):0)} \only<\mathResult->{\selectI \upd{\progPosI}{I}}  
  % \only<{\fpEval{4}}->{\selectI \upd{\progPosI}{I}}
  \evalMRI{\animBase + 0} \only<\MRI->{\selectI \upd{\progPosI}{I}}
  
  \only<5->{\upd{\progPosI}{II}}
  \only<6->{\selectII \upd{\progPosII}{I}}
  \only<7->{\upd{\progPosII}{II}}
  \only<8->{\upd{\progPosII}{I}}
  \only<9->{\upd{\progPosII}{II}}
  \only<10->{\selectI \upd{\progPosI}{IV}}
  \only<11->{\selectII \upd{\progPosII}{I}}
  \only<12->{\upd{\progPosII}{II}}
  \only<13->{\upd{\progPosII}{IV}}


  \begin{columns}

    \begin{column}{0.5\linewidth}
      \spinlockClientIIExpandedIter
    \end{column}

    \begin{column}{0.4\linewidth}
      \only<2->{
        % \scSystem
        \begin{tikzpicture}[xscale=1, yscale=1]
          \myrect{T1}{(0, 0)}{Thread 1}{1cm}{0.5cm}{\tIcolor!50};
          \myrect{T2}{(3, 0)}{Thread 2}{1cm}{0.5cm}{\tIIcolor!50};          
          
          \myrectBorder{Mem}{(1.5, -2)}{\large{$l \leftarrow \only<-4,10-11,13->{0}\only<5-9,12>{1}$}}{5cm}{0.5cm}{black};
          
          \draw[mem,transform canvas={xshift=0.3cm}] (T1.south) -- (T1.south |- Mem.north);
          \draw[mem,transform canvas={xshift=-0.3cm}] (T1.south |- Mem.north) -- (T1.south);
          \draw[mem,transform canvas={xshift=0.3cm}] (T2.south) -- (T2.south |- Mem.north);
          \draw[mem,transform canvas={xshift=-0.3cm}] (T2.south |- Mem.north) -- (T2.south);
        \end{tikzpicture}
      }
    \end{column}

  \end{columns}
   
  \vspace{0.5cm}

  \onslide<3->{
  \begin{center}
    \begin{traceenv}{1.5}{0.9}
      \stepcounter{evctr}
      \onslide<5->{\node at (\curEv, 1) {$\ulab{}{l}{0}{1}$ \stepcounter{evctr}};}
      \onslide<7->{\node at (\curEv, 0) {$\rlab{}{l}{1}$ \stepcounter{evctr}};}
      \onslide<9->{\node at (\curEv, 0) {$\rlab{}{l}{1}$ \stepcounter{evctr}};}
      \onslide<10->{\node at (\curEv, 1) {$\wlab{}{l}{0}$ \stepcounter{evctr}};}
      \onslide<12->{\node at (\curEv, 0) {$\ulab{}{l}{0}{1}$ \stepcounter{evctr}};}
      \onslide<13->{\node at (\curEv, 0) {$\wlab{}{l}{0}$ \stepcounter{evctr}};}
    \end{traceenv}
  \end{center}
  }
  

  % \only<4->{
  % }

  
  % \onslide<4>{%
  %   \tikz[overlay,remember picture]
  %   % \node[fill=white,text=\colorTitleApprox,draw=black]
  %   % at ([xshift=-5cm,yshift=0cm]current page.center){But now we use:};
  %   \myrect
  % }

\end{frame}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "oopsla"
%%% End:
